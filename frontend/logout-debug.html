<!DOCTYPE html>
<html>
<head>
  <title>Logout Test - Interactive</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #f5f5f5; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
    h1 { color: #333; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .section h3 { margin-top: 0; }
    .test-item { padding: 10px; margin: 10px 0; border-left: 4px solid #ccc; }
    .pass { border-left-color: green; color: green; font-weight: bold; }
    .fail { border-left-color: red; color: red; font-weight: bold; }
    .info { border-left-color: blue; color: blue; }
    button { padding: 10px 20px; margin: 10px 5px 10px 0; cursor: pointer; font-size: 16px; }
    .btn-primary { background: #007bff; color: white; border: none; border-radius: 4px; }
    .btn-primary:hover { background: #0056b3; }
    .btn-danger { background: #dc3545; color: white; border: none; border-radius: 4px; }
    .btn-danger:hover { background: #c82333; }
    #logoutBtn { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
    #logoutBtn:hover { background: #c82333; }
    .output { background: #f9f9f9; border: 1px solid #ddd; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
    .localStorage-info { background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Logout Functionality Test</h1>

    <div class="section">
      <h3>1. Setup Test User</h3>
      <p>Click the button below to create a test storekeeper account and log in:</p>
      <button class="btn-primary" onclick="setupTestUser()">Create Test User & Login</button>
      <div id="setupStatus" class="test-item" style="display:none;"></div>
    </div>

    <div class="section">
      <h3>2. Current User Status</h3>
      <div id="userStatus" class="localStorage-info">
        <p><strong>Token:</strong> <span id="tokenDisplay">Not set</span></p>
        <p><strong>User:</strong> <span id="userDisplay">Not set</span></p>
      </div>
    </div>

    <div class="section">
      <h3>3. Logout Button Test</h3>
      <p>This is the actual logout button that should redirect you to the login page:</p>
      <button id="logoutBtn">Logout</button>
      <div id="logoutStatus" class="test-item" style="display:none;"></div>
    </div>

    <div class="section">
      <h3>4. Simulated Logout (without redirect)</h3>
      <p>Click this button to test logout WITHOUT redirecting (to see what happens):</p>
      <button class="btn-danger" onclick="simulatedLogout()">Test Logout (No Redirect)</button>
    </div>

    <div class="section">
      <h3>5. Console Output</h3>
      <div id="console" class="output">Console output will appear here...\n</div>
    </div>
  </div>

  <script>
    // Redirect console to page
    const consoleDiv = document.getElementById('console');
    const originalLog = console.log;
    const originalError = console.error;

    console.log = function(...args) {
      const msg = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
      consoleDiv.textContent += msg + '\n';
      consoleDiv.parentElement.scrollTop = consoleDiv.parentElement.scrollHeight;
      originalLog.apply(console, args);
    };

    console.error = function(...args) {
      const msg = 'ERROR: ' + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
      consoleDiv.textContent += msg + '\n';
      consoleDiv.parentElement.scrollTop = consoleDiv.parentElement.scrollHeight;
      originalError.apply(console, args);
    };

    console.log('=== Logout Test Page Loaded ===\n');

    // Update user status display
    function updateUserStatus() {
      const token = localStorage.getItem('token');
      const user = localStorage.getItem('user');
      
      document.getElementById('tokenDisplay').textContent = token ? token.slice(0, 30) + '...' : 'Not set';
      document.getElementById('userDisplay').textContent = user ? JSON.parse(user).username : 'Not set';
    }

    // Setup test user
    async function setupTestUser() {
      console.log('\nSETUP: Creating test user...');
      const randId = Math.random().toString(36).substring(7);
      const email = `logout_test_${randId}@example.com`;
      const password = 'TestPass123!';

      try {
        // Signup
        const signupRes = await fetch('http://localhost:5000/api/users/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: `logout_${randId}`,
            email,
            password,
            role: 'storekeeper',
            storeName: 'Test Store',
            location: 'Test'
          })
        });

        if (!signupRes.ok) {
          throw new Error('Signup failed');
        }

        console.log('‚úì Signup successful');

        // Signin
        const signinRes = await fetch('http://localhost:5000/api/users/signin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (!signinRes.ok) {
          throw new Error('Signin failed');
        }

        const signinData = await signinRes.json();
        localStorage.setItem('token', signinData.token);
        localStorage.setItem('user', JSON.stringify(signinData.user));

        console.log('‚úì Signin successful');
        console.log(`‚úì User: ${signinData.user.username}`);
        console.log(`‚úì Token stored in localStorage`);
        console.log(`‚úì User data stored in localStorage\n`);

        updateUserStatus();

        // Check logout button
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          console.log('‚úì Logout button element found');
          
          // Try to add event listener
          if (logoutBtn.addEventListener) {
            console.log('‚úì Logout button supports addEventListener');
          } else {
            console.error('‚úó Logout button does NOT support addEventListener');
          }
        } else {
          console.error('‚úó Logout button NOT found!');
        }

        document.getElementById('setupStatus').innerHTML = '<strong class="pass">‚úì Test user created and logged in successfully!</strong>';
        document.getElementById('setupStatus').style.display = 'block';

      } catch (err) {
        console.error('Setup error: ' + err.message);
        document.getElementById('setupStatus').innerHTML = '<strong class="fail">‚úó Setup failed: ' + err.message + '</strong>';
        document.getElementById('setupStatus').style.display = 'block';
      }
    }

    // Simulated logout
    function simulatedLogout() {
      console.log('\nSIMULATED LOGOUT (No redirect):');
      console.log('1. Removing token from localStorage...');
      localStorage.removeItem('token');
      console.log('   ‚úì Token removed');
      
      console.log('2. Removing user from localStorage...');
      localStorage.removeItem('user');
      console.log('   ‚úì User removed');
      
      console.log('3. Would redirect to index.html (skipped in this test)\n');
      
      updateUserStatus();
      
      document.getElementById('logoutStatus').innerHTML = '<strong class="pass">‚úì Simulated logout successful!</strong><br>localStorage has been cleared.<br>In a real logout, you would be redirected to index.html';
      document.getElementById('logoutStatus').style.display = 'block';
    }

    // Actual logout button handler
    document.addEventListener('DOMContentLoaded', () => {
      console.log('\nDOMContentLoaded event fired');
      
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        console.log('‚úì Found logout button');
        
        logoutBtn.addEventListener('click', () => {
          console.log('\nüîÑ LOGOUT BUTTON CLICKED!');
          console.log('1. Removing token...');
          localStorage.removeItem('token');
          console.log('   ‚úì Token removed');
          
          console.log('2. Removing user...');
          localStorage.removeItem('user');
          console.log('   ‚úì User removed');
          
          console.log('3. Redirecting to index.html...');
          console.log('   (Page will navigate away in 2 seconds...)\n');
          
          // Update display before redirect
          updateUserStatus();
          document.getElementById('logoutStatus').innerHTML = '<strong class="pass">‚úì Logout successful!</strong><br>Redirecting to login page...';
          document.getElementById('logoutStatus').style.display = 'block';
          
          // Redirect after a short delay so user can see the message
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        });
        
        console.log('‚úì Event listener attached to logout button');
      } else {
        console.error('‚úó Logout button NOT found!');
      }
    });

    // Initial status
    updateUserStatus();
  </script>
</body>
</html>
